<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>이미지 대사 생성기</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #222;
        }
        canvas {
            box-shadow: 0 5px 30px rgba(0,0,0,0.6);
            /* 모바일에서 이미지가 화면을 넘어가지 않도록 처리 */
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        /* 로딩 메시지 스타일 */
        #loading-message {
            color: white;
            font-size: 24px;
            font-family: sans-serif;
        }
    </style>
</head>
<body>
    <canvas id="mainCanvas"></canvas>
    <div id="loading-message">이미지를 불러오는 중... URL에 imageUrl 파라미터를 추가하세요.</div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('mainCanvas');
            const ctx = canvas.getContext('2d');
            const loadingMessage = document.getElementById('loading-message');

            // --- 텍스트 자동 줄바꿈 함수 ---
            function wrapText(context, text, x, y, maxWidth, lineHeight) {
                const words = text.split(' ');
                let line = '';
                const lines = [];

                for(let n = 0; n < words.length; n++) {
                    const testLine = line + words[n] + ' ';
                    const metrics = context.measureText(testLine);
                    const testWidth = metrics.width;
                    if (testWidth > maxWidth && n > 0) {
                        lines.push(line);
                        line = words[n] + ' ';
                    } else {
                        line = testLine;
                    }
                }
                lines.push(line);
                
                lines.forEach((l, i) => {
                    context.fillText(l.trim(), x, y + (i * lineHeight));
                });
            }

            function draw() {
                const params = new URLSearchParams(window.location.search);

                const imageUrl = params.get('imageUrl');
                if (!imageUrl) {
                    loadingMessage.style.display = 'block';
                    canvas.style.display = 'none';
                    return;
                }
                
                loadingMessage.style.display = 'none';
                canvas.style.display = 'block';
                
                const img = new Image();
                // ✨ CORS 허용 서버의 이미지를 불러오기 위한 필수 설정
                img.crossOrigin = "Anonymous";

                img.onload = () => {
                    // --- 파라미터 기본값 설정 ---
                    const text = params.get('text') || "대사를 입력하세요. (text=...)";
                    const boxHeightPercent = parseInt(params.get('boxHeight') || '25', 10);
                    const boxColor = params.get('boxColor') || 'rgba(0, 0, 0, 0.7)';
                    const textColor = params.get('textColor') || 'white';
                    const fontSize = parseInt(params.get('fontSize') || '28', 10);
                    const padding = fontSize; // 여백을 폰트 크기와 동일하게 설정

                    // --- 캔버스 설정 ---
                    const width = img.width;
                    const height = img.height;
                    canvas.width = width;
                    canvas.height = height;
                    
                    // 1. 원본 이미지를 그립니다.
                    ctx.drawImage(img, 0, 0);

                    // 2. 대사 상자를 그립니다.
                    const boxHeight = height * (boxHeightPercent / 100);
                    const boxY = height - boxHeight;
                    ctx.fillStyle = boxColor;
                    ctx.fillRect(0, boxY, width, boxHeight);

                    // 3. 대사를 씁니다. (자동 줄바꿈 적용)
                    ctx.fillStyle = textColor;
                    ctx.font = `bold ${fontSize}px 'Malgun Gothic', sans-serif`;
                    ctx.textAlign = 'left';
                    ctx.textBaseline = 'top';
                    
                    const textX = padding;
                    const textY = boxY + padding;
                    const maxWidth = width - (padding * 2);
                    const lineHeight = fontSize * 1.4;

                    // 엔터(\n)를 기준으로 먼저 나누고, 각 줄에 대해 자동 줄바꿈을 적용합니다.
                    const textLines = text.split('\n');
                    let currentY = textY;
                    textLines.forEach(lineText => {
                        wrapText(ctx, lineText, textX, currentY, maxWidth, lineHeight);
                        // 수동 줄바꿈 후 Y 위치 조정을 위해 임시로 텍스트를 다시 그려서 높이를 계산 (간단한 구현)
                        const tempLines = [];
                        let tempLine = '';
                        const words = lineText.split(' ');
                         for(let n = 0; n < words.length; n++) {
                            const testLine = tempLine + words[n] + ' ';
                            if (ctx.measureText(testLine).width > maxWidth && n > 0) {
                                tempLines.push(tempLine);
                                tempLine = words[n] + ' ';
                            } else {
                                tempLine = testLine;
                            }
                        }
                        tempLines.push(tempLine);
                        currentY += tempLines.length * lineHeight;
                    });
                };

                img.onerror = () => {
                    canvas.style.display = 'none';
                    loadingMessage.style.display = 'block';
                    loadingMessage.textContent = "이미지를 불러올 수 없습니다. 이미지 링크나 CORS 정책을 확인해주세요.";
                };
                
                img.src = imageUrl;
            }

            draw();
        });
    </script>
</body>
</html>